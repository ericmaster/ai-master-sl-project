
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Supervised Learning Project: Predicción de distancia en competencias de ultra trail running &#8212; Supervised Learning Project</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_project';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="project.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.jpg" class="logo__image only-light" alt="Supervised Learning Project - Home"/>
    <script>document.write(`<img src="_static/logo.jpg" class="logo__image only-dark" alt="Supervised Learning Project - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="project.html">
                    Supervised Learning Project: Predicción de distancia para competencias de ultra trail running
                </a>
            </li>
        </ul>
        
    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ericmaster/ml-project" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ericmaster/ml-project/issues/new?title=Issue%20on%20page%20%2F_project.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/_project.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Supervised Learning Project: Predicción de distancia en competencias de ultra trail running</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduccion">Introducción</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation-y-justificacion">Motivation y Justificación</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#que-es-el-running">¿Qué es el running?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#que-es-el-trail-running">¿Qué es el trail running?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#que-es-el-ultra-trail-running">¿Qué es el <em>ultra</em> trail running?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#por-que-es-importante">¿Por qué es importante?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#eda-exploratory-data-analysis">EDA (Exploratory Data Analysis)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preprocessing">Data preprocessing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analisis-de-los-datos">Análisis de los datos</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#graficas-de-variables-con-respecto-al-tiempo">Gráficas de variables con respecto al tiempo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#observaciones">Observaciones:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Observaciones</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Observaciones</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Observaciones</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizacion-con-tsne">Visualización con TSNE</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Observaciones:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Observaciones:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-selection-filter">Feature Selection (Filter)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lag-features">Lag Features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conjuntos-de-entrenamiento-validacion-y-prueba">Conjuntos de entrenamiento, validación y prueba</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Observaciones:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparacion-de-estadistica-de-2-tecnicas-de-ml">Comparación de estadística de 2 técnicas de ML</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regresion-lineal-regularizada">Regresión Lineal Regularizada</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#librerias-requeridas">Librerias requeridas</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#preparacion-de-datos">Preparación de datos</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pipeline">Pipeline</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizacion-de-hyperparametros">Optimización de hyperparámetros</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizacion-de-resultados">Visualización de resultados</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#entrenamiento-y-evaluacion">Entrenamiento y Evaluación</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#neural-network-con-tft-temporal-fusion-transformers">Neural Network con TFT (Temporal Fusion Transformers)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Librerias requeridas</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset">Dataset</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-and-hyperparameter-optimization">Model and Hyperparameter Optimization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#re-train-with-best-parameters">Re-train with best parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparacion-de-modelos">Comparación de modelos</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusiones">Conclusiones</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#referencias">Referencias</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="supervised-learning-project-prediccion-de-distancia-en-competencias-de-ultra-trail-running">
<h1>Supervised Learning Project: Predicción de distancia en competencias de ultra trail running<a class="headerlink" href="#supervised-learning-project-prediccion-de-distancia-en-competencias-de-ultra-trail-running" title="Link to this heading">#</a></h1>
<section id="introduccion">
<h2>Introducción<a class="headerlink" href="#introduccion" title="Link to this heading">#</a></h2>
<section id="motivation-y-justificacion">
<h3>Motivation y Justificación<a class="headerlink" href="#motivation-y-justificacion" title="Link to this heading">#</a></h3>
<section id="que-es-el-running">
<h4>¿Qué es el running?<a class="headerlink" href="#que-es-el-running" title="Link to this heading">#</a></h4>
<p>El <em><strong>running</strong></em> es una actividad física que implica desplazar el cuerpo una cierta distancia de manera repetida sobre varios intervalos de tiempo hasta realizar un recorrido. Esto implica la activación de muchos músculos que, dependiendo de la condición física y entrenamiento de la persona y en menor medida de otros factores como el clima y el desnivel, permitirá hacer el recorrido en mayor o menor tiempo. Visto de otra manera permitirá recorrer mayor o menor distancia, en un intervalo de tiempo definido. El <em>running</em> se practica por lo general en vias asfaltadas con poco o ningún desnivel por lo que el resultado de la actividad es muy <strong>predecible</strong> basado en la condición física de la persona y entrenamiento.</p>
<p><img alt="image" src="home/eaguayo/workspace/ml-project/images/running.png" />
<em>Generated with ChatGPT with prompt “Generate an image of a runner athlete running on a street, viewed from the side with an image of an analog stopwatch above his head, and a ghosted image of the same runner about 10 meters ahead with the stopwatch above his head having advanced a few seconds. Draw a metered line below the runner and it’s ghosted image indicating the displaced space between them.”</em></p>
</section>
<section id="que-es-el-trail-running">
<h4>¿Qué es el trail running?<a class="headerlink" href="#que-es-el-trail-running" title="Link to this heading">#</a></h4>
<p>El <em><strong>trail running</strong></em> es una actividad física al igual que el <em>running</em>, implica desplazar el cuerpo una distancia de manera repetida pero que se diferencia del <em>running</em> en que la actividad se realiza usualmente en senderos y caminos de tercer orden. La actividad del <strong>trail running</strong> implica muchas condiciones que cambian durante el transcurso de la actividad (morfología del terreno, desnivel, condiciones climáticas) que dificultan predecir el resultado de la actividad. Estas variables adicionales representan un desafío para una planificación estratégica que maximice el rendimiento del deportista durante el recorrido.</p>
<p><img alt="image" src="home/eaguayo/workspace/ml-project/images/trail-running.png" />
<em>Generated with ChatGPT with prompt “Generate an image consisting on 2 images side-by-side. On the left hand side, draw a trail runner viewed from the side power walking uphill on a mountain trail on a steep hill on a sunny day with clear sky. On the right hand side, draw the same trail runner using a rain jacket, running downhill on a rocky trail on a rainy day with cloudy sky.”</em></p>
</section>
<section id="que-es-el-ultra-trail-running">
<h4>¿Qué es el <em>ultra</em> trail running?<a class="headerlink" href="#que-es-el-ultra-trail-running" title="Link to this heading">#</a></h4>
<p>El <em><strong>ultra trail running</strong></em> es una actividad de <em>ultra resistencia</em>, que se entiende como una actividad que tiene una duración de más de 4 horas, pudiendo extenderse a varios días incluso. Algunas fuentes(<a class="reference external" href="https://www.dynafit.com/what-is-trail-running">https://www.dynafit.com/what-is-trail-running</a>) definen a la actividad por su distancia, superando la distancia de una maraton (42.195 km) y que en el caso del <em>trail running</em>, es común que realizar recorridos que superen esta distancia supere también las 4 horas pero dependerá del desnivel y de la capacidad del atleta.</p>
<p>En el <em>ultra trail running</em>, las condiciones climáticas, entre otros factores externos, tienen una mayor probabilidad de cambiar debido a la prolongada duración de la actividad teniendo que por lo general ajustar la estrategia sobre la marcha. A diferencia de deportes de resistencia o de corta duración, los deportes de ultra resistencia presentan un desafío adicional debido a los cambios fisiológicos que sufre el cuerpo del atleta durante la práctica prolongada de la actividad. El gasto energético constante y la pérdida de electrolitos tienden a generar un déficit que tiene que ser compensado con cierta frecuencia por lo que la nutrición, antes y durante la actividad, es importante para obtener un buen resultado. El ritmo o intensidad a la que se lleva a cabo la actividad también tiene que ser moderada para evitar la acumulación execisva de ácido láctico que puede llevar a niveles de fatiga exesivos e ir en contra del desempeño del deportista.</p>
</section>
<section id="por-que-es-importante">
<h4>¿Por qué es importante?<a class="headerlink" href="#por-que-es-importante" title="Link to this heading">#</a></h4>
<p>En la práctica del <em>ultra trail running</em> es importante tener una noción del tiempo estimado en que tomará realizar un recorrido, este se estima usualmente con un gran margen de error en base a experiencias anteriores en recorridos similares. Es común tomar este tiempo estimado para realizar una planificación estratégica que, sobre todo a nivel competitivo, permitirá máximizar los resultados, es decir, poder realizar el recorrido en el menor tiempo posible.</p>
<p>El <em>trail running</em> y sobre todo el <em>ultra trail running</em>, son actividades que por lo general se practican en auto-suficiencia, es decir, que es responsabilidad del practicante llevar el equipo y materiales necesarios para llevar a cabo con éxito el recorrido. Esto incluye llevar consigo la cantidad de alimentos y líquidos necesarios para reponer el gasto energético y perdida de electrolítos antes mencionadas. Parte de la estrategia llevar la cantidad justa de alimentos y líquidos entre puntos de control durante la competencia. Llevar más de lo necesario conlleva a cargar más peso y por ende un mayor gasto energético y mayor tiempo en completar la distancia. Por otro lado, llevar menos de lo necesario conlleva el riesgo de quedarse sin alimentos o liquidos durante el recorrido con el peligro de sufrir una descompensación que de prolongarse por mucho tiempo puede tener consecuencias potencialmente graves para el deportista.</p>
<p>Tener un tiempo estimado de recorrido tanto total como por segmentos, ayuda al deportista a que tener una noción del ritmo que deberia llevar sobre cada segmento. Por ejemplo, si después de un determinado tiempo de haber iniciado la actividad, el deportista ha recorrido una distancia menor de la estimada sobre ese tiempo se podría decir que esta llevando un ritmo muy comodo y que podría elevar su ritmo de carrera para hacer un menor tiempo. Asi mismo, si despues de un determinado tiempo de haber iniciado el recorrido, el deportista se encuentra por delante de la posición estimada a ese tiempo y dependiendo del recorrido restante podría bajar el ritmo para evitar la acumulación de ácido láctico y el desgaste general.</p>
</section>
</section>
</section>
<section id="eda-exploratory-data-analysis">
<h2>EDA (Exploratory Data Analysis)<a class="headerlink" href="#eda-exploratory-data-analysis" title="Link to this heading">#</a></h2>
<section id="data-preprocessing">
<h3>Data preprocessing<a class="headerlink" href="#data-preprocessing" title="Link to this heading">#</a></h3>
<p>Antes que el EDA pueda ser filtrado, los datos necesitos ser filtrados y preprocesados extrayendo las sesiones de entrenamiento de la carpeta <code class="docutils literal notranslate"><span class="pre">full-data</span></code> que contiene <em>todas</em> las sesiones de entrenamiento entre disciplinas y duraciones.</p>
<p>El enfoque de este proyecto esta en analizar las sesiones de entrenamientos de trail running que tienen una duración entre 4 y 6 horas. Inicialmente los datos estaban filtrados a mayores de 3 horas pero el dataset resultaba muy grande con casi 3 millones de registros por lo cual el tiempo de ejecución del procesamiento y análisis era muy alto. Las sesiones de entrenamiento vienen en formato JSON con cada métrica almacenada en una clave distinta e indexada por su <code class="docutils literal notranslate"><span class="pre">timestamp</span></code>.</p>
<p>De acuerdo con el artículo <a class="reference external" href="https://medium.com/data-science/how-not-to-use-machine-learning-for-time-series-forecasting-avoiding-the-pitfalls-19f9d7adf424">How (not) to use Machine Learning for time series forecasting: Avoiding the pitfalls</a> para algunas métricas es más importante tener la diferencia con la muestra predecesora en la secuencia que la métrica en si por lo cual nuevas columnas serán generadas con éste lineamiento.</p>
<p>Otra observación importante es que en los registros de altura, el sensor de altura registra a diferentes intervalos que la frecuencia de muestreo. Algunas alternativas fueron realizar resampling de todo el muestreo para generar una frecuencia que este acorde con la frecuencia de muestreo de la altura. Otra alternativa era realizar una interpolación de datos para la altura para no tener saltos bruscos de un intervalo a otro. A la final, se aplico una técnica de “Rolling Mean” como se describe en <a class="reference external" href="https://medium.com/&#64;rahulholla1/advanced-feature-engineering-for-time-series-data-5f00e3a8ad29">Advanced Feature Engineering for Time Series Data</a></p>
<p>No se esperaría tener patrones que presenten una periodicidad o un “Seasonalinity” como en el caso de otras series de tiempo que se menciona en la literatura de manera común.</p>
<p>Luego de procesar las métricas de interés se almacenarán en formato CSV para su procesamiento tabular dentro de la carpeta <code class="docutils literal notranslate"><span class="pre">long-tr-data</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install rdflib to use isodate</span>
<span class="o">%</span><span class="k">pip</span> install rdflib
<span class="o">%</span><span class="k">pip</span> install isodate
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Defaulting to user installation because normal site-packages is not writeable
Requirement already satisfied: rdflib in /home/eaguayo/.local/lib/python3.10/site-packages (7.1.4)
Requirement already satisfied: isodate&lt;1.0.0,&gt;=0.7.2 in /home/eaguayo/.local/lib/python3.10/site-packages (from rdflib) (0.7.2)
Requirement already satisfied: pyparsing&lt;4,&gt;=2.1.0 in /usr/local/lib/python3.10/dist-packages (from rdflib) (3.1.2)
Defaulting to user installation because normal site-packages is not writeable
Requirement already satisfied: isodate in /home/eaguayo/.local/lib/python3.10/site-packages (0.7.2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">isodate</span>

<span class="c1"># from concurrent.futures import ThreadPoolExecutor, as_completed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="c1"># Create the output directory if it doesn&#39;t exist</span>
<span class="c1"># output_dir = &quot;./data/long-tr-data&quot;</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="s2">&quot;/home/eaguayo/workspace/ml-project/data/long-tr-data&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Iterate through all files in the ./full-data folder</span>
<span class="c1"># input_dir = &quot;./data/full-data&quot;</span>
<span class="n">input_dir</span> <span class="o">=</span> <span class="s2">&quot;/home/eaguayo/workspace/ml-project/data/full-data&quot;</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">start_hours</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">end_hours</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c1"># Note: Following code was partially Generated with Copilot autocomplete feature</span>
<span class="c1"># No specific prompts were used</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">input_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">exercise</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exercises&quot;</span><span class="p">,</span> <span class="p">[])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 1. check if the sport corresponds to trail running and if the duration is greater than 3 hours</span>
        <span class="c1">#    also check if the file has already been processed</span>
        <span class="n">sport</span> <span class="o">=</span> <span class="n">exercise</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sport&quot;</span><span class="p">)</span>
        <span class="n">duration_iso</span> <span class="o">=</span> <span class="n">exercise</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;duration&quot;</span><span class="p">)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">isodate</span><span class="o">.</span><span class="n">parse_duration</span><span class="p">(</span><span class="n">duration_iso</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">sport</span> <span class="o">!=</span> <span class="s2">&quot;TRAIL_RUNNING&quot;</span>
            <span class="ow">or</span> <span class="n">duration</span> <span class="o">&lt;</span> <span class="n">start_hours</span> <span class="o">*</span> <span class="mi">3600</span>
            <span class="ow">or</span> <span class="n">duration</span> <span class="o">&gt;</span> <span class="n">end_hours</span> <span class="o">*</span> <span class="mi">3600</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Skip processing if the output file already exists</span>
        <span class="n">output_file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># 2. Extract available data ---</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing file: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">sample_features</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;heartRate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;altitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;distance&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cadence&quot;</span><span class="p">,</span>
            <span class="s2">&quot;speed&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">exercise</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Initialize main dataframe with heart rate samples</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;dateTime&quot;</span><span class="p">]),</span>
                    <span class="s2">&quot;heartRate&quot;</span><span class="p">:</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="n">sample</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;heartRate&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Date</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># Calculate timestamp diff and add it to the dataframe as a new column</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Process and merge other sample types</span>
        <span class="k">for</span> <span class="n">sample_feature</span> <span class="ow">in</span> <span class="n">sample_features</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># Skip heartRate (already in df)</span>
            <span class="n">sample_data</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sample_feature</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_data</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;dateTime&quot;</span><span class="p">]),</span>
                        <span class="n">sample_feature</span><span class="p">:</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="n">sample</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sample_data</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sample_feature</span> <span class="o">==</span> <span class="s2">&quot;distance&quot;</span><span class="p">:</span>
                <span class="c1"># Calculate distance difference</span>
                <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;distance_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">sample_feature</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sample_feature</span> <span class="o">==</span> <span class="s2">&quot;altitude&quot;</span><span class="p">:</span>
                <span class="c1"># Smooth altitude data</span>
                <span class="n">temp_df</span><span class="p">[</span><span class="n">sample_feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">temp_df</span><span class="p">[</span><span class="n">sample_feature</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="c1"># Calculate elevation difference</span>
                <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;elevation_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">sample_feature</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># Calculate elevation gain</span>
                <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;elevation_gain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;elevation_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># Calculate elevation loss</span>
                <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;elevation_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;elevation_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">sample_feature</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># Within a second is very likely that the same sample is repeated</span>
                <span class="n">temp_df</span><span class="p">[</span><span class="n">sample_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">sample_feature</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">temp_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Save the dataframe to a CSV file</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved processed data to: </span><span class="si">{</span><span class="n">output_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing time for </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: File not found at path: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Invalid JSON format in file: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred in file: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;With error </span><span class="si">{</span><span class="n">exc_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Traceback:&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># Get the list of files</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_dir</span><span class="p">)</span>

<span class="c1"># Process files sequentially</span>
<span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">process_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># break # Uncomment to process only the first file for testing</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># Process files in parallel with a progress bar</span>
<span class="c1"># TODO: Does not seem to work well from vscode ipynb with local kernel</span>
<span class="c1">#   or remote jupyter server runtime. Maybe split to a separate .py script file.</span>
<span class="c1"># with ThreadPoolExecutor(max_workers=8) as executor:</span>
<span class="c1">#     futures = {executor.submit(process_file, file_name): file_name for file_name in files}</span>
<span class="c1">#     for future in tqdm(as_completed(futures), total=len(futures)):</span>
<span class="c1">#         if future.result():</span>
<span class="c1">#             count += 1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2"> files.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> files.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1468/1468 [00:50&lt;00:00, 29.00it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Skipped 1468 files.
Processed 0 files.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="analisis-de-los-datos">
<h3>Análisis de los datos<a class="headerlink" href="#analisis-de-los-datos" title="Link to this heading">#</a></h3>
<p>Luego de procesar los datos se procede a realizar un EDA sobre los datos almacenados en la carpeta <code class="docutils literal notranslate"><span class="pre">long-tr-data</span></code>. El objetivo es tener un entedimiento del comportamiento de métricas como ritmo cardiaco, altitud, distancia, velocidad, entre otras e identificar patrones o comportamientos que podrían ser útiles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import requiered libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="c1"># Define the directory containing the processed data</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;./data/long-tr-data&#39;</span>
<span class="c1"># Get the training files list</span>
<span class="n">training_files</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load and process all CSV files </span>
<span class="n">data_frames</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">training_files</span><span class="p">:</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="c1"># Downsample into 2 seconds intervals</span>
    <span class="c1"># For time execution reasons... ¯\_(ツ)_/¯</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Temporarily drop the date column to avoid resampling issues</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;2S&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
    <span class="c1"># Fill heart rate NaN values with the mean of the column</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;heartRate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;heartRate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Fill other NaN values with the closest values of the column or 0</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cadence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cadence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Combine all data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data_frames</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Display basic information about the dataset</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>

<span class="c1"># Display summary statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 445949 entries, 0 to 445948
Data columns (total 13 columns):
 #   Column          Non-Null Count   Dtype         
---  ------          --------------   -----         
 0   timestamp       445949 non-null  datetime64[ns]
 1   heartRate       445949 non-null  float64       
 2   duration        445949 non-null  float64       
 3   altitude        445949 non-null  float64       
 4   elevation_diff  445949 non-null  float64       
 5   elevation_gain  445949 non-null  float64       
 6   elevation_loss  445949 non-null  float64       
 7   distance        445949 non-null  float64       
 8   distance_diff   445949 non-null  float64       
 9   temperature     445949 non-null  float64       
 10  cadence         445949 non-null  float64       
 11  speed           445949 non-null  float64       
 12  date            445949 non-null  object        
dtypes: datetime64[ns](1), float64(11), object(1)
memory usage: 44.2+ MB
None
                           timestamp      heartRate       duration  \
count                         445949  445949.000000  445949.000000   
mean   2023-01-28 06:14:12.129916160     127.194541    9033.975995   
min              2021-05-01 05:07:14      54.000000       0.000000   
25%              2022-03-12 06:16:34     111.500000    4458.500000   
50%              2022-12-17 15:02:28     128.500000    8917.500000   
75%              2023-12-29 13:43:50     143.500000   13377.500000   
max              2025-04-20 14:44:56     190.500000   21479.000000   
std                              NaN      21.119468    5349.574275   

            altitude  elevation_diff  elevation_gain  elevation_loss  \
count  445949.000000   445949.000000   445949.000000   445949.000000   
mean     3578.155676       -0.001501     1062.817693     -503.378252   
min      1259.449000      -13.914400        0.000000    -2821.442400   
25%      3055.992500       -0.106600      593.514400     -845.583100   
50%      3697.269000        0.000000     1125.487700     -327.103500   
75%      4254.298000        0.183000     1521.177500      -34.960000   
max      4801.725000       14.981000     2535.418000        0.000000   
std       778.492176        0.292445      573.726286      547.679914   

            distance  distance_diff    temperature        cadence  \
count  445949.000000  445949.000000  445949.000000  445949.000000   
mean    11416.721658       1.347686      15.841314      59.042547   
min         0.000000       0.000000       4.600000       0.000000   
25%      5403.099854       0.549927      11.500000      49.500000   
50%      9676.450195       1.199219      15.300000      61.000000   
75%     15885.949707       2.049805      19.800000      79.500000   
max     52028.898438      72.000000      33.700000     117.500000   
std      8120.755213       1.091821       5.603107      25.686741   

               speed  
count  445949.000000  
mean        4.935611  
min         0.000000  
25%         2.360000  
50%         4.390000  
75%         7.310000  
max        83.560000  
std         3.626671  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>  <span class="c1"># For reproducibility</span>
<span class="n">sample_data_frames</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">data_frames</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="graficas-de-variables-con-respecto-al-tiempo">
<h3>Gráficas de variables con respecto al tiempo<a class="headerlink" href="#graficas-de-variables-con-respecto-al-tiempo" title="Link to this heading">#</a></h3>
<p>Realizamos unas gráficas para entender el comportamiento de las variables sobre el tiempo de algunas sesiones de entrenamiento escogidas al azar. Por lo pronto explorando el <em>ritmo cardíaco</em>, <em>altitud</em> y <em>velocidad</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function to plot time series data for a single training session</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_time_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
    <span class="c1"># Convert duration from seconds to hours for x-axis</span>
    <span class="n">time_hours</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">3600</span>

    <span class="c1"># Plot heart rate over time</span>
    <span class="c1"># Calculate rolling mean and standard deviation for heart rate</span>
    <span class="n">hr_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">hr_window</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">hr_rolling_mean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;heartRate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">hr_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">hr_rolling_std</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;heartRate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">hr_window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">hr_index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_hours</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;heartRate&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Heart Rate (bpm)&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">hr_index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">time_hours</span><span class="p">,</span>
        <span class="n">hr_rolling_mean</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rolling Mean (</span><span class="si">{</span><span class="n">hr_window</span><span class="si">}</span><span class="s2"> sec)&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">hr_index</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
        <span class="n">time_hours</span><span class="p">,</span>
        <span class="n">hr_rolling_mean</span> <span class="o">-</span> <span class="n">hr_rolling_std</span><span class="p">,</span>
        <span class="n">hr_rolling_mean</span> <span class="o">+</span> <span class="n">hr_rolling_std</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Rolling Std Dev&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">hr_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Heart Rate Over Time&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">hr_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">hr_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Heart Rate (bpm)&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">hr_index</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Plot altitude over time</span>
    <span class="n">a_index</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">a_index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">time_hours</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Altitude (meters)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">a_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Altitude Over Time&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">a_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">a_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Altitude (meters)&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">a_index</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Plot speed over time</span>
    <span class="n">s_index</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">s_window</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">s_rolling_mean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">s_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">s_rolling_std</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">s_window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">s_index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_hours</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Speed (min/km)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">s_index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">time_hours</span><span class="p">,</span>
        <span class="n">s_rolling_mean</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rolling Mean (</span><span class="si">{</span><span class="n">hr_window</span><span class="si">}</span><span class="s2"> sec)&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">s_index</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
        <span class="n">time_hours</span><span class="p">,</span>
        <span class="n">s_rolling_mean</span> <span class="o">-</span> <span class="n">s_rolling_std</span><span class="p">,</span>
        <span class="n">s_rolling_mean</span> <span class="o">+</span> <span class="n">s_rolling_std</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Rolling Std Dev&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">s_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Speed Over Time&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">s_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">s_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Speed (min/km)&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">s_index</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Create a 3x3 subplot figure and plot time series for 3 random files</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="c1"># axes = axes.flatten()</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample_df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_data_frames</span><span class="p">[:</span><span class="mi">2</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sample_df</span><span class="p">)</span>
    <span class="c1"># print(f&quot;Plotting {file_path}&quot;)</span>
    <span class="n">plot_time_series</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">axes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                timestamp  heartRate  duration   altitude  elevation_diff  \
0     2023-12-29 09:07:50       77.0       0.5  3148.6220          0.0000   
1     2023-12-29 09:07:52       78.5       2.5  3148.7135          0.0915   
2     2023-12-29 09:07:54       80.0       4.5  3149.0795          0.1830   
3     2023-12-29 09:07:56       80.5       6.5  3149.5521          0.2896   
4     2023-12-29 09:07:58       81.5       8.5  3150.1615          0.3047   
...                   ...        ...       ...        ...             ...   
10594 2023-12-29 15:00:58       93.0   21188.5  3152.5840          0.0000   
10595 2023-12-29 15:01:00       94.0   21190.5  3152.5840          0.0000   
10596 2023-12-29 15:01:02       95.0   21192.5  3152.5840          0.0000   
10597 2023-12-29 15:01:04       95.0   21194.5  3152.5840          0.0000   
10598 2023-12-29 15:01:06       95.0   21196.0  3152.5840          0.0000   

       elevation_gain  elevation_loss      distance  distance_diff  \
0              0.0000          0.0000      0.000000       0.000000   
1              0.0915          0.0000      0.000000       0.000000   
2              0.4575          0.0000      0.000000       0.000000   
3              0.9301          0.0000      0.000000       0.000000   
4              1.5395          0.0000      0.000000       0.000000   
...               ...             ...           ...            ...   
10594       1902.5188      -1898.5568  27636.600586       1.200195   
10595       1902.5188      -1898.5568  27639.750000       1.649414   
10596       1902.5188      -1898.5568  27641.800781       0.600586   
10597       1902.5188      -1898.5568  27641.800781       0.000000   
10598       1902.5188      -1898.5568  27641.800781       0.000000   

       temperature  cadence  speed        date  
0             23.8      0.0  0.000  2023-12-29  
1             23.8      0.0  0.000  2023-12-29  
2             23.8      0.0  0.000  2023-12-29  
3             23.8     37.0  0.000  2023-12-29  
4             23.7     50.0  0.000  2023-12-29  
...            ...      ...    ...         ...  
10594         20.2      0.0  2.325  2023-12-29  
10595         20.2      0.0  2.490  2023-12-29  
10596         20.2     13.5  1.935  2023-12-29  
10597         20.2     47.0  0.000  2023-12-29  
10598         20.2     49.0  0.000  2023-12-29  

[10599 rows x 13 columns]
               timestamp  heartRate  duration   altitude  elevation_diff  \
0    2021-06-06 05:09:06      107.0       0.0  2907.6750          0.0000   
1    2021-06-06 05:09:08      109.5       1.5  2907.6750          0.0000   
2    2021-06-06 05:09:10      113.5       3.5  2907.7816          0.1066   
3    2021-06-06 05:09:12      115.0       5.5  2908.2080          0.2132   
4    2021-06-06 05:09:14      118.0       7.5  2908.6344          0.2132   
...                  ...        ...       ...        ...             ...   
7717 2021-06-06 09:26:20      150.0   15433.5  2889.5996         -0.0914   
7718 2021-06-06 09:26:22      150.0   15435.5  2889.2340         -0.1828   
7719 2021-06-06 09:26:24      149.0   15437.5  2888.8684         -0.1828   
7720 2021-06-06 09:26:26      149.5   15439.5  2888.7770          0.0000   
7721 2021-06-06 09:26:28      148.0   15441.0  2888.7770          0.0000   

      elevation_gain  elevation_loss      distance  distance_diff  \
0             0.0000          0.0000      0.000000           0.00   
1             0.0000          0.0000      0.000000           0.00   
2             0.1066          0.0000      0.000000           0.00   
3             0.5330          0.0000      0.300000           0.25   
4             0.9594          0.0000      1.900000           1.25   
...              ...             ...           ...            ...   
7717       1025.8726      -1043.9480  25498.599609           0.00   
7718       1025.8726      -1044.3136  25498.599609           0.00   
7719       1025.8726      -1044.6792  25498.599609           0.00   
7720       1025.8726      -1044.7706  25498.599609           0.00   
7721       1025.8726      -1044.7706  25498.599609           0.00   

      temperature  cadence   speed        date  
0           22.60      0.0  0.0000  2021-06-06  
1           22.60      0.0  0.0425  2021-06-06  
2           22.55      0.0  0.6176  2021-06-06  
3           22.50     30.0  4.6518  2021-06-06  
4           22.50     73.5  7.4015  2021-06-06  
...           ...      ...     ...         ...  
7717        19.10     91.5  3.4700  2021-06-06  
7718        19.10     93.0  2.9500  2021-06-06  
7719        19.20     93.0  2.5800  2021-06-06  
7720        19.25     93.0  1.1550  2021-06-06  
7721        19.30     93.0  0.0000  2021-06-06  

[7722 rows x 13 columns]
</pre></div>
</div>
<img alt="_images/d4b619a4323bf5cee7ff22f41615c47dc47cae39fa3a34885b58fe4c877936ee.png" src="_images/d4b619a4323bf5cee7ff22f41615c47dc47cae39fa3a34885b58fe4c877936ee.png" />
</div>
</div>
<section id="observaciones">
<h4>Observaciones:<a class="headerlink" href="#observaciones" title="Link to this heading">#</a></h4>
<p>Es interesante ver que existe una cierta relación entre el ritmo cardíaco y la altura en el que se observa que el ritmo cardíaco tiene una cierta tendencia a disminuir que podría deberse al efecto de la altura o un efecto de la fatiga por el desnivel positivo acumulado. El ritmo cardíaco se recupera e incrementa inmediatamente durante los planos y bajadas. No se aprecia una correlación directa entre la velocidad y la altura aunque si hay cierta relación entre la velocidad y el ritmo cardiaco al inicio del ascenso o descenso.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the distribution of heart rate</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;heartRate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of Heart Rate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Heart Rate (bpm)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b38954322430565594e49592cdfb0bc5ed045d67f66502b3574dd01cbe7078f2.png" src="_images/b38954322430565594e49592cdfb0bc5ed045d67f66502b3574dd01cbe7078f2.png" />
</div>
</div>
</section>
<section id="id1">
<h4>Observaciones<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<p>La mayoría de los entrenamientos fueron en zona 1 y 2 (100 a 130 BPMs para el individuo de estudio) y zona 4 - 5 ( &gt; 158 BPMs para el individuo de estudio). No obstante en entrenamientos largos (fondos) y compentencias de larga duración, el ritmo cardíaco tiende a mantenerse en una zona aerobica por lo cual se observa que el ritmo cardiaco predomina alrededor de los 140 BPMs</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the distribution of altitude</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;altitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of Altitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Altitude (meters)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/396514b3e4b6c0b13ad81a5dc97516f63f02228f862da2c8c66fe50e9c683b36.png" src="_images/396514b3e4b6c0b13ad81a5dc97516f63f02228f862da2c8c66fe50e9c683b36.png" />
</div>
</div>
</section>
<section id="id2">
<h4>Observaciones<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<p>Al residir en la ciudad de Quito, la mayoria de los entrenamientos largos fueron en altura a ~3000 metros de altura (Quito y sus alrededores principalmente) y ~4500 metros de altura (zona Integrales del Ruco Pichincha)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function to calculate and plot correlations between metrics</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_metric_correlations</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="c1"># Calculate correlation matrix</span>
    <span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

    <span class="c1"># Plot heatmap of correlations</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.2f&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Correlation Matrix&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot correlations for the first file in the directory</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample_df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_data_frames</span><span class="p">[:</span><span class="mi">2</span><span class="p">]):</span>
    <span class="n">plot_metric_correlations</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">]))</span>

<span class="c1"># Plot correlations for the aggregated dataframe</span>
<span class="n">plot_metric_correlations</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fc7d1f24ff34e440e20e7fa0288e37689363ddd73f8256dbac387aca24ff45f1.png" src="_images/fc7d1f24ff34e440e20e7fa0288e37689363ddd73f8256dbac387aca24ff45f1.png" />
<img alt="_images/65c7ba89d5c14ccdb610d7fb58280211cc1477423f8427bd076c05e934719d78.png" src="_images/65c7ba89d5c14ccdb610d7fb58280211cc1477423f8427bd076c05e934719d78.png" />
<img alt="_images/f06988103c9690d3b2de5e972e1c50a3b176e339a3765772dc7f3f9efe2e1f4b.png" src="_images/f06988103c9690d3b2de5e972e1c50a3b176e339a3765772dc7f3f9efe2e1f4b.png" />
</div>
</div>
</section>
<section id="id3">
<h4>Observaciones<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<p>Se observa que hay una muy alta correlacion entre la distancia y la duración de la actividad, esto es de esperarse ya que la distancia recorrida siempre incrementa a medida que el corredor va avanzando en el tiempo, no obstante la differencia de distancia por segundo (<code class="docutils literal notranslate"><span class="pre">distance_diff</span></code>) tiene una baja correlación. Esta misma correlación se puede observar entre el desnivel positivo acumulado (<code class="docutils literal notranslate"><span class="pre">elevation_gain</span></code>) y la duración ya que usualmente la velocidad disminuye con el desnivel reduciendo la distancia que se avanza por cada intervalo de tiempo.</p>
<p>Debido a que el muestreo es de 1Hz es decir cada medida se toma por cada segundo, <code class="docutils literal notranslate"><span class="pre">distance_diff</span></code> puede interpretarse como una medida de velocidad, es por eso que también es de esperarse una alta correlación entre esta métrica y la velocidad (medida en min/km).</p>
<p>En menor medida se puede observar también que hay cierta correlación entre la cadencia y la velocidad (y por ende la diferencia de distancia). Una mayor cadencia no necesariamente implica mayor velocidad, pero en muchos casos si, si es que se mantiene un tamaño de zancada constante.</p>
</section>
</section>
<section id="visualizacion-con-tsne">
<h3>Visualización con TSNE<a class="headerlink" href="#visualizacion-con-tsne" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># About 90% of the code in this cell was generated with Copilot</span>
<span class="c1"># Prompt: Add a TSNE visualization for the data in 2 dimensions using distance_diff as the color.</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Select a subset of features for TSNE</span>
<span class="n">tsne_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;heartRate&quot;</span><span class="p">,</span> <span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="s2">&quot;cadence&quot;</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">]</span>
<span class="c1"># Join a subset of the sample dataframes into a single dataframe</span>
<span class="n">sample_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sample_data_frames</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tsne_data</span> <span class="o">=</span> <span class="n">sample_data</span><span class="p">[</span><span class="n">tsne_features</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Apply TSNE</span>
<span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">tsne_results</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">tsne_data</span><span class="p">)</span>

<span class="c1"># Create a scatter plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">tsne_results</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">tsne_results</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="n">tsne_data</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;TSNE Visualization of Data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;TSNE Dimension 1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;TSNE Dimension 2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3b33179ae41c5349e0298e226ef4aefb813cefe18fd5c2e344a764526c22705a.png" src="_images/3b33179ae41c5349e0298e226ef4aefb813cefe18fd5c2e344a764526c22705a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">pip</span> install tslearn --quiet
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">374.4/374.4 kB</span> <span class=" -Color -Color-Red">5.7 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>a <span class=" -Color -Color-Cyan">0:00:01</span>
?25h
</pre></div>
</div>
</div>
</div>
<section id="id4">
<h4>Observaciones:<a class="headerlink" href="#id4" title="Link to this heading">#</a></h4>
<p>Por temas de tiempo de ejecución se realizó solo en subconjunto de datos. De todas maneras no se observa grupos muy definidos, posiblemente debido a que no se toma en cuenta la dependencia de las muestras sobre los muestreos anteriores.</p>
<p>No obstante, existe una investigación titulada <a class="reference external" href="https://export.arxiv.org/pdf/1708.07942v1.pdf">m-TSNE: A Framework for Visualizing High-Dimensional Multivariate Time Series</a> en la que utiliza una métrica de distancia para la similaridad de los datos en un dataset de series de tiempo multivariable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># About 90% of code Generated with ChatGPT using the following prompt:</span>
<span class="c1"># &quot;Add a m-TSNE visualization for the data in 2 dimensions using DTW distance as the metric.&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tslearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">dtw</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">mtsne_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;heartRate&quot;</span><span class="p">,</span> <span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="s2">&quot;cadence&quot;</span><span class="p">]</span>
<span class="c1"># Using only one training session for m-TSNE for execution time reasons</span>
<span class="n">mtsne_data</span> <span class="o">=</span> <span class="n">sample_data_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="n">mtsne_data</span> <span class="o">=</span> <span class="n">mtsne_data</span><span class="p">[</span><span class="n">mtsne_features</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">sample_data_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Step 1: Compute pairwise distance matrix using DTW</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">mtsne_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">distance_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing DTW distance matrix (this may take time)...&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">dtw</span><span class="p">(</span><span class="n">mtsne_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mtsne_data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">distance_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span>
        <span class="n">distance_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step 2: Apply t-SNE with precomputed distance matrix</span>
<span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;precomputed&quot;</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">)</span>

<span class="c1"># Step 3: Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">embedding</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">embedding</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;tab10&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Distance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;m-TSNE Visualization&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Component 1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Component 2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d860a4a743642e1c61c6d00588b2841ffdf2f888cd69880832f50ed99df6356a.png" src="_images/d860a4a743642e1c61c6d00588b2841ffdf2f888cd69880832f50ed99df6356a.png" />
</div>
</div>
</section>
<section id="id5">
<h4>Observaciones:<a class="headerlink" href="#id5" title="Link to this heading">#</a></h4>
<p>Se puede observar una representación visual con clusters mas separados de los datos aunque el costo computacional de la matriz de distancias es muy alto en este caso.</p>
</section>
</section>
</section>
<section id="feature-selection-filter">
<h2>Feature Selection (Filter)<a class="headerlink" href="#feature-selection-filter" title="Link to this heading">#</a></h2>
<p>En ésta sección se implementará una técnica de feature selection utilizando <code class="docutils literal notranslate"><span class="pre">SelectKBest</span></code> y <code class="docutils literal notranslate"><span class="pre">GroupTimeSeriesSplit</span></code>.</p>
<section id="lag-features">
<h3>Lag Features<a class="headerlink" href="#lag-features" title="Link to this heading">#</a></h3>
<p>Es común en datasets de series de tiempo trabajar con <em>Lag Features</em> que es una técnica para incorporar en las muestras información sobre los eventos del pasado que consiste en crear nuevos features desplazando la linea del tiempo un cierto intervalo. Ésto permite usar modelos convencionales para hacer predicciones sobre el dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Partially generated by copilot autocomplete feature</span>
<span class="c1"># No prompts were used</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="c1"># Create feature lags</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_feature_lags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create lagged features for a given feature in the DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">periods</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">_lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">_lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
            <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">periods</span> <span class="o">*</span> <span class="p">(</span><span class="n">lag</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">periods</span><span class="p">)</span>
            <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="c1"># Fill NaN values with the mean of the feature</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">_lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="c1"># Create lagged features for heart rate, elevantion_diff, cadence, and temperature</span>
<span class="n">data_lags</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="n">data_lags</span> <span class="o">=</span> <span class="n">create_feature_lags</span><span class="p">(</span><span class="n">data_lags</span><span class="p">,</span> <span class="s2">&quot;heartRate&quot;</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">data_lags</span> <span class="o">=</span> <span class="n">create_feature_lags</span><span class="p">(</span><span class="n">data_lags</span><span class="p">,</span> <span class="s2">&quot;elevation_diff&quot;</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">data_lags</span> <span class="o">=</span> <span class="n">create_feature_lags</span><span class="p">(</span><span class="n">data_lags</span><span class="p">,</span> <span class="s2">&quot;cadence&quot;</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">data_lags</span> <span class="o">=</span> <span class="n">create_feature_lags</span><span class="p">(</span><span class="n">data_lags</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># Check the dimensions of the new DataFrame</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_lags</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(445949, 53)
</pre></div>
</div>
</div>
</div>
</section>
<section id="conjuntos-de-entrenamiento-validacion-y-prueba">
<h3>Conjuntos de entrenamiento, validación y prueba<a class="headerlink" href="#conjuntos-de-entrenamiento-validacion-y-prueba" title="Link to this heading">#</a></h3>
<p>Luego de crear los feature lags, es necesario dividir el dataset en entrenamiento, validación y pruebas. Primero separando un conjunto de datos para las pruebas posteriores. Y luego realizar las divisiones correspondientes sobre el conjunto de datos restante. En este caso los datos estan agrupados por cada uno de los entrenamientos pero también cada entrenamiento corresponde a un conjunto de series de tiempo por lo que se necesitan considerar los dos casos. La clase <code class="docutils literal notranslate"><span class="pre">GroupTimeSeriesSplit</span></code> de la libreria <a class="reference external" href="https://rasbt.github.io/mlxtend/user_guide/evaluate/GroupTimeSeriesSplit/"><code class="docutils literal notranslate"><span class="pre">mlxtend</span></code></a> implementa lo necesario para poder llevar a cabo este proceso</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">pip</span> install mlxtend --quiet
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ensure there are no NaN values in the DataFrame. Fill with 0</span>
<span class="n">data_lags</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Divide by unique dates into test and train sets</span>
<span class="c1"># Keep the corresponding training session groups</span>
<span class="c1"># Only 2025 sessions will be used for ultimate model testing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Convert the comparison string to a datetime.date object</span>
<span class="n">comparison_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot;2025-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

<span class="n">train_val_data</span> <span class="o">=</span> <span class="n">data_lags</span><span class="p">[</span><span class="n">data_lags</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">comparison_date</span><span class="p">]</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">data_lags</span><span class="p">[</span><span class="n">data_lags</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">comparison_date</span><span class="p">]</span>

<span class="c1"># Ensure the data is sorted by date and duration</span>
<span class="n">train_val_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-15-29044d1bf4ed&gt;:16: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  train_val_data.sort_values(by=[&quot;date&quot;, &quot;duration&quot;], inplace=True)
&lt;ipython-input-15-29044d1bf4ed&gt;:17: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  test_data.sort_values(by=[&quot;date&quot;, &quot;duration&quot;], inplace=True)
</pre></div>
</div>
</div>
</div>
<p>Se procede a llevar a cabo la selección de features usando <code class="docutils literal notranslate"><span class="pre">SelectKBest</span></code> con distintos valores de <code class="docutils literal notranslate"><span class="pre">k</span></code> y usando <code class="docutils literal notranslate"><span class="pre">mutual_info_regression</span></code> como métrica de score.</p>
<p>Scikit-learn provee la clase <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.TimeSeriesSplit.html"><code class="docutils literal notranslate"><span class="pre">TimeSeriesSplit</span></code></a> que incorpora un mecanismo de validación cruzada para conjuntos de datos correspondientes a series de tiempo. Desafortunadamente, la naturaleza de los datos no permite utilizar esta clase directamente ya que cada sesión de entrenamiento es diferente una de otra.</p>
<p>Afortunadamente, la libreria <code class="docutils literal notranslate"><span class="pre">mlxtend</span></code> contiene la clase <a class="reference external" href="https://rasbt.github.io/mlxtend/user_guide/evaluate/GroupTimeSeriesSplit/">GroupTimeSeriesSplit</a> que es compatible con scikit-learn y permite la agrupación adecuada de los conjuntos de series de tiempo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Code partially generated with ChatGPT and Copilot assistance</span>
<span class="c1"># Prompt:   &quot;Use https://rasbt.github.io/mlxtend/user_guide/evaluate/GroupTimeSeriesSplit/</span>
<span class="c1">#           to implement feature selection with scikit-learn using SelectKBest</span>
<span class="c1">#           with mutual_info_regression.&quot;</span>

<span class="c1"># Code was updated to implement a pipeline and cross_val_score</span>
<span class="c1"># which wasn&#39;t initially suggested by chatGPT</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.discriminant_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">SelectKBest</span><span class="p">,</span> <span class="n">mutual_info_regression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlxtend.evaluate.time_series</span><span class="w"> </span><span class="kn">import</span> <span class="n">GroupTimeSeriesSplit</span><span class="p">,</span> <span class="n">plot_splits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">cross_validate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>

<span class="c1"># Extract X and y datasets for training</span>
<span class="c1"># Filter train_val_data to test with smaller dataset (last years only) for time sake</span>
<span class="n">train_val_data_f</span> <span class="o">=</span> <span class="n">train_val_data</span><span class="p">[</span>
    <span class="n">train_val_data</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot;2024-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">train_val_data_f</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;distance_diff&quot;</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">train_val_data_f</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span>
<span class="c1"># encode date as consecutive integers</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">train_val_data_f</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
<span class="n">groups</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span><span class="n">dates</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 0 0 ... 7 7 7]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Group-aware time series split</span>
<span class="c1"># Set the test size to 20% of the unique groups</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
<span class="c1"># Only 3 split for the sake of time</span>
<span class="n">cv_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;test_size&quot;</span><span class="p">:</span> <span class="n">test_size</span><span class="p">,</span> <span class="s2">&quot;n_splits&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="n">plot_splits</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="o">**</span><span class="n">cv_args</span><span class="p">)</span>
<span class="n">gtscv</span> <span class="o">=</span> <span class="n">GroupTimeSeriesSplit</span><span class="p">(</span><span class="o">**</span><span class="n">cv_args</span><span class="p">)</span>

<span class="n">k_scores</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">k_results</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># The Pipeline...</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="c1"># (&#39;poly&#39;, PolynomialFeatures(degree=2, include_bias=False)),</span>
        <span class="p">(</span><span class="s2">&quot;scaler&quot;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
        <span class="p">(</span><span class="s2">&quot;feature_selection&quot;</span><span class="p">,</span> <span class="n">SelectKBest</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">mutual_info_regression</span><span class="p">)),</span>
        <span class="p">(</span>
            <span class="s2">&quot;model&quot;</span><span class="p">,</span>
            <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">min_samples_split</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Iterate over different values of k for feature selection</span>
<span class="n">k_values</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating k values: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">k_values</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">selected_features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">pipeline</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">feature_selection__k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span>
        <span class="n">pipeline</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">gtscv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;neg_mean_squared_error&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">)</span>
    <span class="c1"># k_results = cross_validate(</span>
    <span class="c1">#     pipeline, X, y, groups=groups, cv=gtscv, verbose=3, return_estimator=True</span>
    <span class="c1"># )</span>

    <span class="c1"># Store results</span>
    <span class="n">k_scores</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1f26e55a0631f87befb7870357d86f175c4cec9a1c7d65b2ffb2e4048ffde8a9.png" src="_images/1f26e55a0631f87befb7870357d86f175c4cec9a1c7d65b2ffb2e4048ffde8a9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluating k values: [29, 32, 35, 38, 41, 44]
Evaluating k=29...
[CV] END ....................... score: (test=-134496098.785) total time= 1.6min
[CV] END ........................ score: (test=-25642393.360) total time= 1.6min
[CV] END ........................ score: (test=-46000543.835) total time= 1.6min
Evaluating k=32...
[CV] END ....................... score: (test=-133761361.544) total time= 1.7min
[CV] END ........................ score: (test=-25551826.558) total time= 1.8min
[CV] END ........................ score: (test=-46603525.059) total time= 1.8min
Evaluating k=35...
[CV] END ....................... score: (test=-135892815.756) total time= 1.9min
[CV] END ........................ score: (test=-25441719.662) total time= 2.0min
[CV] END ........................ score: (test=-47438894.681) total time= 1.9min
Evaluating k=38...
[CV] END ....................... score: (test=-139214667.158) total time= 2.0min
[CV] END ........................ score: (test=-25809072.009) total time= 2.1min
[CV] END ........................ score: (test=-46570927.552) total time= 2.1min
Evaluating k=41...
[CV] END ....................... score: (test=-137267653.930) total time= 2.2min
[CV] END ........................ score: (test=-26265625.697) total time= 2.2min
[CV] END ........................ score: (test=-46806181.913) total time= 2.2min
Evaluating k=44...
[CV] END ....................... score: (test=-136824326.348) total time= 2.3min
[CV] END ........................ score: (test=-25649436.773) total time= 2.4min
[CV] END ........................ score: (test=-45927286.286) total time= 2.3min
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select best k value</span>
<span class="n">best_k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">k_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">k_scores</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
<span class="n">best_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">k_scores</span><span class="p">[</span><span class="n">best_k</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best k value: </span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2"> with score: </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best k value: 32 with score: -68650383.19
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h3>Observaciones:<a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<p>El tiempo de ejecución es considerablemente alto si es que se considera todo el dataset y un mayor numero de folds asi como varios valores de k.</p>
<p>Para simplificar el proceso y reducir el tiempo de ejecución, se tomó un subconjunto de los datos, asi como menos opciones de evaluación para k y el numero de folds se redujo de 3 a 5</p>
<p>El mejor valor de k encontrado fue de 32 con los parámetros dados</p>
</section>
</section>
<section id="comparacion-de-estadistica-de-2-tecnicas-de-ml">
<h2>Comparación de estadística de 2 técnicas de ML<a class="headerlink" href="#comparacion-de-estadistica-de-2-tecnicas-de-ml" title="Link to this heading">#</a></h2>
<p>Se van a comparar 2 técnicas de ML para el conjunto de datos:</p>
<ul class="simple">
<li><p>Regresión Lineal Regularizada</p></li>
<li><p>NN con TFT (Temporal Fusion Transformers)</p></li>
</ul>
<section id="regresion-lineal-regularizada">
<h3>Regresión Lineal Regularizada<a class="headerlink" href="#regresion-lineal-regularizada" title="Link to this heading">#</a></h3>
<section id="librerias-requeridas">
<h4>Librerias requeridas<a class="headerlink" href="#librerias-requeridas" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.discriminant_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ridge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlxtend.evaluate</span><span class="w"> </span><span class="kn">import</span> <span class="n">GroupTimeSeriesSplit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="c1"># from sklearn.model_selection import RepeatedKFold</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="preparacion-de-datos">
<h4>Preparación de datos<a class="headerlink" href="#preparacion-de-datos" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract X and y datasets for training</span>
<span class="c1"># Filter train_val_data to test with smaller dataset (last year only) for time sake</span>
<span class="c1"># train_val_data_s = train_val_data[train_val_data[&quot;date&quot;] &gt; datetime.strptime(&quot;2024-01-01&quot;, &quot;%Y-%m-%d&quot;).date()]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">train_val_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;distance_diff&quot;</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">train_val_data</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span>
<span class="c1"># According to GroupTimeSeriesSplit documentation, the groups should be sequential</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">train_val_data</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
<span class="n">groups</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span><span class="n">dates</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;distance_diff&quot;</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">])</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span>
<span class="c1"># dates_test = pd.to_datetime(test_data[&quot;date&quot;])</span>
<span class="c1"># groups_test = pd.factorize(dates)[0]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="pipeline">
<h4>Pipeline<a class="headerlink" href="#pipeline" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="c1"># (&#39;poly&#39;, PolynomialFeatures(degree=2, include_bias=False)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">&quot;feature_selection&quot;</span><span class="p">,</span> <span class="n">SelectKBest</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">mutual_info_regression</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">best_k</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;ridge&#39;</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="optimizacion-de-hyperparametros">
<h4>Optimización de hyperparámetros<a class="headerlink" href="#optimizacion-de-hyperparametros" title="Link to this heading">#</a></h4>
<p>Se utilizará <code class="docutils literal notranslate"><span class="pre">GroupTimeSeriesSplit</span></code> en lugar de <code class="docutils literal notranslate"><span class="pre">RepeatedKFold</span></code> por el tipo de problema.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ridge__alpha&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)}</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CV Params:&quot;</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">)</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
<span class="n">cv_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;test_size&quot;</span><span class="p">:</span> <span class="n">test_size</span><span class="p">,</span> <span class="s2">&quot;n_splits&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
<span class="n">gtscv</span> <span class="o">=</span> <span class="n">GroupTimeSeriesSplit</span><span class="p">(</span><span class="o">**</span><span class="n">cv_args</span><span class="p">)</span>

<span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">lr_pipeline</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">gtscv</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;neg_mean_squared_error&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best parameters found:&quot;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best score:&quot;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CV Params: {&#39;ridge__alpha&#39;: array([1.00000000e-03, 1.77827941e-02, 3.16227766e-01, 5.62341325e+00,
       1.00000000e+02])}
Fitting 10 folds for each of 5 candidates, totalling 50 fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[CV 1/10] END ridge__alpha=0.001;, score=(train=-7500550.590, test=-25338487.163) total time= 1.2min
[CV 2/10] END ridge__alpha=0.001;, score=(train=-7287329.948, test=-23950498.870) total time= 1.2min
[CV 3/10] END ridge__alpha=0.001;, score=(train=-6940894.347, test=-25811455.493) total time= 1.2min
[CV 4/10] END ridge__alpha=0.001;, score=(train=-6931917.164, test=-27954242.373) total time= 1.2min
[CV 5/10] END ridge__alpha=0.001;, score=(train=-8793647.434, test=-42579476.865) total time= 1.2min
[CV 6/10] END ridge__alpha=0.001;, score=(train=-8840434.654, test=-50262258.420) total time= 1.2min
[CV 7/10] END ridge__alpha=0.001;, score=(train=-8351187.371, test=-54999903.062) total time= 1.2min
[CV 8/10] END ridge__alpha=0.001;, score=(train=-7884821.545, test=-53047462.251) total time= 1.2min
[CV 9/10] END ridge__alpha=0.001;, score=(train=-9689415.369, test=-38369111.763) total time= 1.2min
[CV 10/10] END ridge__alpha=0.001;, score=(train=-9610390.238, test=-37468476.911) total time= 1.2min
[CV 1/10] END ridge__alpha=0.01778279410038923;, score=(train=-7500550.590, test=-25338500.036) total time= 1.2min
[CV 2/10] END ridge__alpha=0.01778279410038923;, score=(train=-7287329.948, test=-23950509.595) total time= 1.2min
[CV 3/10] END ridge__alpha=0.01778279410038923;, score=(train=-6940894.347, test=-25811465.792) total time= 1.2min
[CV 4/10] END ridge__alpha=0.01778279410038923;, score=(train=-6931917.164, test=-27954253.297) total time= 1.2min
[CV 5/10] END ridge__alpha=0.01778279410038923;, score=(train=-8793647.434, test=-42579488.189) total time= 1.2min
[CV 6/10] END ridge__alpha=0.01778279410038923;, score=(train=-8840434.654, test=-50262276.973) total time= 1.2min
[CV 7/10] END ridge__alpha=0.01778279410038923;, score=(train=-8351187.371, test=-54999920.947) total time= 1.2min
[CV 8/10] END ridge__alpha=0.01778279410038923;, score=(train=-7884821.545, test=-53047481.555) total time= 1.2min
[CV 9/10] END ridge__alpha=0.01778279410038923;, score=(train=-9689415.369, test=-38369121.416) total time= 1.2min
[CV 10/10] END ridge__alpha=0.01778279410038923;, score=(train=-9610390.238, test=-37468485.917) total time= 1.2min
[CV 1/10] END ridge__alpha=0.31622776601683794;, score=(train=-7500550.591, test=-25338728.962) total time= 1.2min
[CV 2/10] END ridge__alpha=0.31622776601683794;, score=(train=-7287329.949, test=-23950700.326) total time= 1.2min
[CV 3/10] END ridge__alpha=0.31622776601683794;, score=(train=-6940894.348, test=-25811648.921) total time= 1.2min
[CV 4/10] END ridge__alpha=0.31622776601683794;, score=(train=-6931917.165, test=-27954447.551) total time= 1.2min
[CV 5/10] END ridge__alpha=0.31622776601683794;, score=(train=-8793647.436, test=-42579689.562) total time= 1.2min
[CV 6/10] END ridge__alpha=0.31622776601683794;, score=(train=-8840434.655, test=-50262606.897) total time= 1.2min
[CV 7/10] END ridge__alpha=0.31622776601683794;, score=(train=-8351187.372, test=-55000238.982) total time= 1.2min
[CV 8/10] END ridge__alpha=0.31622776601683794;, score=(train=-7884821.546, test=-53047824.845) total time= 1.2min
[CV 9/10] END ridge__alpha=0.31622776601683794;, score=(train=-9689415.371, test=-38369293.072) total time= 1.2min
[CV 10/10] END ridge__alpha=0.31622776601683794;, score=(train=-9610390.241, test=-37468646.059) total time= 1.2min
[CV 1/10] END ridge__alpha=5.62341325190349;, score=(train=-7500550.906, test=-25342798.979) total time= 1.2min
[CV 2/10] END ridge__alpha=5.62341325190349;, score=(train=-7287330.265, test=-23954091.332) total time= 1.2min
[CV 3/10] END ridge__alpha=5.62341325190349;, score=(train=-6940894.609, test=-25814904.735) total time= 1.2min
[CV 4/10] END ridge__alpha=5.62341325190349;, score=(train=-6931917.442, test=-27957901.027) total time= 1.2min
[CV 5/10] END ridge__alpha=5.62341325190349;, score=(train=-8793647.872, test=-42583269.788) total time= 1.2min
[CV 6/10] END ridge__alpha=5.62341325190349;, score=(train=-8840434.994, test=-50268472.069) total time= 1.2min
[CV 7/10] END ridge__alpha=5.62341325190349;, score=(train=-8351187.623, test=-55005892.688) total time= 1.2min
[CV 8/10] END ridge__alpha=5.62341325190349;, score=(train=-7884821.812, test=-53053927.583) total time= 1.2min
[CV 9/10] END ridge__alpha=5.62341325190349;, score=(train=-9689416.045, test=-38372344.915) total time= 1.2min
[CV 10/10] END ridge__alpha=5.62341325190349;, score=(train=-9529712.472, test=-37057096.535) total time= 1.2min
[CV 1/10] END ridge__alpha=100.0;, score=(train=-7500641.026, test=-25414863.713) total time= 1.2min
[CV 2/10] END ridge__alpha=100.0;, score=(train=-7287420.063, test=-24014148.823) total time= 1.2min
[CV 3/10] END ridge__alpha=100.0;, score=(train=-6940968.318, test=-25872550.507) total time= 1.2min
[CV 4/10] END ridge__alpha=100.0;, score=(train=-6931995.248, test=-28019015.727) total time= 1.2min
[CV 5/10] END ridge__alpha=100.0;, score=(train=-8793775.845, test=-42646702.515) total time= 1.2min
[CV 6/10] END ridge__alpha=100.0;, score=(train=-8840537.053, test=-50372208.656) total time= 1.2min
[CV 7/10] END ridge__alpha=100.0;, score=(train=-8351263.651, test=-55105854.850) total time= 1.2min
[CV 8/10] END ridge__alpha=100.0;, score=(train=-7884903.519, test=-53161852.051) total time= 1.2min
[CV 9/10] END ridge__alpha=100.0;, score=(train=-9689624.274, test=-38426401.525) total time= 1.2min
[CV 10/10] END ridge__alpha=100.0;, score=(train=-9610600.221, test=-37521952.819) total time= 1.2min
Best parameters found: {&#39;ridge__alpha&#39;: 5.62341325190349}
Best score: -37941069.96498461
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="visualizacion-de-resultados">
<h3>Visualización de resultados<a class="headerlink" href="#visualizacion-de-resultados" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Extract alphas and scores</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">cv_results_</span>
<span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ridge__alpha&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]]</span>

<span class="c1"># Convert negative MSE to positive for interpretability (optional)</span>
<span class="n">mean_test_scores</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;mean_test_score&#39;</span><span class="p">])</span>
<span class="n">std_test_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;std_test_score&#39;</span><span class="p">])</span>

<span class="n">mean_train_scores</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;mean_train_score&#39;</span><span class="p">])</span>
<span class="n">std_train_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;std_train_score&#39;</span><span class="p">])</span>

<span class="c1"># Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">mean_test_scores</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Score&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">mean_train_scores</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Score&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Alpha&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss (MSE)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train vs Test Score across Ridge Alphas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2a9d09c4ba8fe192b00a06826a134c1bed629a73ccb1ca7f3f2d9c4d7631a180.png" src="_images/2a9d09c4ba8fe192b00a06826a134c1bed629a73ccb1ca7f3f2d9c4d7631a180.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">learning_curve</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Use the best parameter (e.g., ridge__alpha from GridSearchCV)</span>
<span class="n">best_alpha</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;ridge__alpha&#39;</span><span class="p">]</span>
<span class="n">lr_pipeline</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">ridge__alpha</span><span class="o">=</span><span class="n">best_alpha</span><span class="p">)</span>

<span class="c1"># Define train sizes (fractions or absolute numbers)</span>
<span class="n">train_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># Reuse the same cross-validator</span>
<span class="n">train_sizes</span><span class="p">,</span> <span class="n">train_scores</span><span class="p">,</span> <span class="n">test_scores</span> <span class="o">=</span> <span class="n">learning_curve</span><span class="p">(</span>
    <span class="n">lr_pipeline</span><span class="p">,</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
    <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
    <span class="n">train_sizes</span><span class="o">=</span><span class="n">train_sizes</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">gtscv</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;neg_mean_squared_error&quot;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">return_times</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1"># Convert negative MSE to positive</span>
<span class="n">train_scores_mean</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_scores_mean</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">test_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">train_scores_mean</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Score&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">test_scores_mean</span><span class="p">,</span> <span class="s1">&#39;s--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Score&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Training Set Size&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;MSE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Learning Curve (Ridge Regression)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">&lt;ipython-input-1-1b1867d13a50&gt;</span> in <span class="ni">&lt;cell line: 6&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="c1"># Use the best parameter (e.g., ridge__alpha from GridSearchCV)</span>
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="n">best_alpha</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;ridge__alpha&#39;</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">lr_pipeline</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">ridge__alpha</span><span class="o">=</span><span class="n">best_alpha</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> 

<span class="ne">NameError</span>: name &#39;grid&#39; is not defined
</pre></div>
</div>
</div>
</div>
<section id="entrenamiento-y-evaluacion">
<h4>Entrenamiento y Evaluación<a class="headerlink" href="#entrenamiento-y-evaluacion" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use best alpha to set the pipeline estimator</span>
<span class="n">lr_pipeline</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">ridge__alpha</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;ridge__alpha&quot;</span><span class="p">])</span>
<span class="n">lr_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># Evaluate the model</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">lr_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">lr_mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Squared Error: </span><span class="si">{</span><span class="n">lr_mse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean Squared Error: 12335562.30
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="neural-network-con-tft-temporal-fusion-transformers">
<h3>Neural Network con TFT (Temporal Fusion Transformers)<a class="headerlink" href="#neural-network-con-tft-temporal-fusion-transformers" title="Link to this heading">#</a></h3>
<p>Existen varios modelos y técnicas útiles que se pueden aplicar sobre problemas de series de tiempo (LSTM, ARIMA, entre otros). No obstante, <a class="reference external" href="https://medium.com/ai-simplified-in-plain-english/an-in-depth-exploration-of-temporal-fusion-transformers-for-time-series-forecasting-91e74040a079">An In-Depth Exploration of Temporal Fusion Transformers for Time Series Forecasting</a> explora las ventajas de usar Temporal Fusion Transformers en cuanto a precisión e interpretabilidad en datos secuenciales dado su mecanismo de atención a los sucesos por lo que se procederá a implementar con pytorch usando ésta técnica</p>
<section id="id7">
<h4>Librerias requeridas<a class="headerlink" href="#id7" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">pip</span> install pytorch-lightning --quiet
<span class="o">%</span><span class="k">pip</span> install pytorch-forecasting --quiet
<span class="o">%</span><span class="k">pip</span> install optuna --quiet
<span class="o">%</span><span class="k">pip</span> install optuna[visualization] --quiet
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">386.6/386.6 kB</span> <span class=" -Color -Color-Red">5.7 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>a <span class=" -Color -Color-Cyan">0:00:01</span>
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">231.9/231.9 kB</span> <span class=" -Color -Color-Red">24.3 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">231.9/231.9 kB</span> <span class=" -Color -Color-Red">24.3 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>[?25l     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">0.0/231.9 kB</span> <span class=" -Color -Color-Red">?</span> eta <span class=" -Color -Color-Cyan">-:--:--</span>
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">78.5/78.5 kB</span> <span class=" -Color -Color-Red">11.1 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">78.5/78.5 kB</span> <span class=" -Color -Color-Red">11.1 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25h
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># About 80% of the code was generated with ChatGPT and Copilot assistance</span>
<span class="c1"># Prompt: &quot;Add a pytorch-lightning model using the Temporal Fusion Transformer (TFT) from pytorch-forecasting.&quot;</span>
<span class="c1"># Prompt: &quot;Implement hyperparameter optimization for the pytorch-lightning tft model&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lightning.pytorch</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<span class="c1"># from pytorch_lightning import Trainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytorch_forecasting</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeriesDataSet</span><span class="p">,</span> <span class="n">Baseline</span><span class="p">,</span> <span class="n">metrics</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytorch_forecasting.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">NaNLabelEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.callbacks.early_stopping</span><span class="w"> </span><span class="kn">import</span> <span class="n">EarlyStopping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">LearningRateMonitor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.loggers</span><span class="w"> </span><span class="kn">import</span> <span class="n">TensorBoardLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytorch_forecasting.data.encoders</span><span class="w"> </span><span class="kn">import</span> <span class="n">TorchNormalizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytorch_forecasting.models.temporal_fusion_transformer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemporalFusionTransformer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">optuna</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="dataset">
<h4>Dataset<a class="headerlink" href="#dataset" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 0   timestamp       445949 non-null  datetime64[ns]</span>
<span class="c1">#  1   heartRate       445902 non-null  float64</span>
<span class="c1">#  2   duration        445949 non-null  float64</span>
<span class="c1">#  3   altitude        445949 non-null  float64</span>
<span class="c1">#  4   elevation_diff  445949 non-null  float64</span>
<span class="c1">#  5   elevation_gain  445949 non-null  float64</span>
<span class="c1">#  6   elevation_loss  445949 non-null  float64</span>
<span class="c1">#  7   distance        445937 non-null  float64</span>
<span class="c1">#  8   distance_diff   445949 non-null  float64</span>
<span class="c1">#  9   temperature     445949 non-null  float64</span>
<span class="c1">#  10  cadence         445939 non-null  float64</span>
<span class="c1">#  11  speed           445939 non-null  float64</span>
<span class="c1">#  12  date            445949 non-null  object</span>

<span class="c1"># --- Configuration ---</span>
<span class="n">min_prediction_length</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">max_prediction_length</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Forecast horizon</span>
<span class="n">min_encoder_length</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">max_encoder_length</span> <span class="o">=</span> <span class="mi">24</span>  <span class="c1"># History length</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>

<span class="c1"># --- Group-aware TimeSeriesDataSet ---</span>
<span class="c1"># data.set_index(&quot;duration&quot;, inplace=True)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">training_cutoff</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">max_prediction_length</span>

<span class="n">training</span> <span class="o">=</span> <span class="n">TimeSeriesDataSet</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">training_cutoff</span><span class="p">],</span>
    <span class="n">time_idx</span><span class="o">=</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="s2">&quot;distance&quot;</span><span class="p">,</span>
    <span class="n">group_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span>
    <span class="n">max_encoder_length</span><span class="o">=</span><span class="n">max_encoder_length</span><span class="p">,</span>
    <span class="n">min_encoder_length</span><span class="o">=</span><span class="n">min_encoder_length</span><span class="p">,</span>
    <span class="n">min_prediction_length</span><span class="o">=</span><span class="n">min_prediction_length</span><span class="p">,</span>
    <span class="n">max_prediction_length</span><span class="o">=</span><span class="n">max_prediction_length</span><span class="p">,</span>
    <span class="c1"># static_categoricals=[],</span>
    <span class="c1"># time_varying_known_categoricals=[],</span>
    <span class="n">time_varying_known_reals</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;duration&quot;</span><span class="p">,</span>
        <span class="s2">&quot;heartRate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;altitude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;elevation_diff&quot;</span><span class="p">,</span>
        <span class="s2">&quot;elevation_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;elevation_loss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cadence&quot;</span><span class="p">,</span>
        <span class="s2">&quot;speed&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">time_varying_unknown_reals</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">],</span>
    <span class="n">target_normalizer</span><span class="o">=</span><span class="n">TorchNormalizer</span><span class="p">(),</span>
    <span class="n">add_relative_time_idx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">add_target_scales</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">add_encoder_length</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_missing_timesteps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Create validation set</span>
<span class="n">validation</span> <span class="o">=</span> <span class="n">TimeSeriesDataSet</span><span class="o">.</span><span class="n">from_dataset</span><span class="p">(</span><span class="n">training</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">predict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stop_randomization</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># DataLoaders</span>
<span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">to_dataloader</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">validation</span><span class="o">.</span><span class="n">to_dataloader</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="model-and-hyperparameter-optimization">
<h3>Model and Hyperparameter Optimization<a class="headerlink" href="#model-and-hyperparameter-optimization" title="Link to this heading">#</a></h3>
<p>Para la optimización de parámetros se utilizó la libreria <code class="docutils literal notranslate"><span class="pre">optuna</span></code> que implementa un algoritmo de busqueda con enfoque probabilistico y compatible con la libreria utilizada. También es posible utilizar <code class="docutils literal notranslate"><span class="pre">Tuner</span></code> [6] provisto por pytorch pero <code class="docutils literal notranslate"><span class="pre">optuna</span></code> parece ser mejor opción para optimizar multiples parametros.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
    <span class="c1"># Suggest hyperparameters</span>
    <span class="n">hidden_size</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s2">&quot;hidden_size&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">attention_head_size</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s2">&quot;attention_head_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">dropout</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;dropout&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Define model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">TemporalFusionTransformer</span><span class="o">.</span><span class="n">from_dataset</span><span class="p">(</span>
        <span class="n">training</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">attention_head_size</span><span class="o">=</span><span class="n">attention_head_size</span><span class="p">,</span>
        <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">metrics</span><span class="o">.</span><span class="n">RMSE</span><span class="p">(),</span>
        <span class="n">log_interval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">reduce_on_plateau_patience</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Callbacks</span>
    <span class="n">early_stop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>

    <span class="c1"># Trainer</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
        <span class="n">max_epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">accelerator</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
        <span class="n">limit_train_batches</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stop</span><span class="p">],</span>
        <span class="n">enable_model_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_dataloaders</span><span class="o">=</span><span class="n">train_dataloader</span><span class="p">,</span> <span class="n">val_dataloaders</span><span class="o">=</span><span class="n">val_dataloader</span><span class="p">)</span>

    <span class="n">val_loss</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">callback_metrics</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">val_loss</span>

<span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;minimize&quot;</span><span class="p">)</span>
<span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best trial:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">study</span><span class="o">.</span><span class="n">best_trial</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-05-12 17:27:16,884] A new study created in memory with name: no-name-c5bb193c-cdca-4b5f-8590-4544b54cb0e0
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "33d9b1e2d67e4a47955a9d8317492073", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9d6571f5f5304557a814640e398559de", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ac136dd9c77b4a85b2f4ecf738cc822f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3681df8c47344ff28a72e21c1296efec", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "392ef07a3e6249e8ad0130ca6fbc81f0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "59ed88b8c0844ff9bb3aa017a5e652e6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d5c77b7382604070961c2b22ad0d3a5e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "508090796a9044c39cc09b6ac34d2843", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9245c6bded474d5d8302392ed0994f78", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "cd7bdee1d0aa479a9873c953ec64990d", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-05-12 17:35:34,245] Trial 0 finished with value: 764.5689086914062 and parameters: {&#39;hidden_size&#39;: 10, &#39;attention_head_size&#39;: 2, &#39;dropout&#39;: 0.4704743235305976, &#39;learning_rate&#39;: 0.003993824376065215}. Best is trial 0 with value: 764.5689086914062.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
/usr/local/lib/python3.10/dist-packages/lightning/pytorch/callbacks/model_checkpoint.py:654: Checkpoint directory /home/eaguayo/workspace/ml-project/checkpoints exists and is not empty.
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
/usr/local/lib/python3.10/dist-packages/lightning/pytorch/callbacks/model_checkpoint.py:654: Checkpoint directory /home/eaguayo/workspace/ml-project/checkpoints exists and is not empty.
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ddccd826b2ad49618a8a7271b6f3b231", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4a7a03a18fc549018db8e96ab429217d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "23016782a8e847599d3db343c57dbd0d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "dfafd372f8e24d8bafbe6eee5b0cdf87", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d037d98b46704f7fb6a80fe8277f8094", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "38b7a0faf984411f89cec9ae0c1ba6f9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fa9b7018100b4d0dad70f5d0cc1e5ec4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "29a2fffa033343caa90e751c85192f0e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "967287ce817f464699bac687ab3e8393", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-05-12 17:42:49,736] Trial 1 finished with value: 519.8544921875 and parameters: {&#39;hidden_size&#39;: 12, &#39;attention_head_size&#39;: 2, &#39;dropout&#39;: 0.11027601234664736, &#39;learning_rate&#39;: 0.0005625633851137193}. Best is trial 1 with value: 519.8544921875.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7d15f39ce99a41448986e716bb5913df", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "763428a9007947b1ad412c9942ac3860", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4b1f3810fd664a6092afbcd32b9aeed9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e4193e520b1a4867934c35e791a1b26a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0b50bbc155f046e5911fcf0e09547d63", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1835cbef5dea402ab6da05ae704ff4f4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "02af01d1e00449ee9d390372c0ad8528", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d13451264e7a4298ac40884f4f80dbb1", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ab89041fc0374f258054ee73dc6ba49c", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-05-12 17:50:05,859] Trial 2 finished with value: 680.4268798828125 and parameters: {&#39;hidden_size&#39;: 38, &#39;attention_head_size&#39;: 1, &#39;dropout&#39;: 0.2696198282979161, &#39;learning_rate&#39;: 0.0012535693494217844}. Best is trial 1 with value: 519.8544921875.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "391ad3732132471b87f7af8cb9b75616", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8426429806584681bd57d9fc948ee468", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a0f0aff84c294bea8f0797b5cee589fa", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2f7656f763824f669a661f3dfe8e1e69", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c39b47f671964082a23ba345ec9c28f6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1b5daac1b83f47c4b906fb55e63fafbc", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a675a3d0f24d4182b06a4b73a9194ff0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "aa0c291510fa45f5bd0ec7a5979b2e08", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "468ab91274a04b9d8323ad10450ba574", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "83b27e0de9684b1f982db4c7d3e9ec15", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "954f14a4d0e94adbb6ba0f2fc23ff30d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b1b2706893af483ab5480a50c9abc5c7", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-05-12 18:00:24,789] Trial 3 finished with value: 418.26885986328125 and parameters: {&#39;hidden_size&#39;: 34, &#39;attention_head_size&#39;: 2, &#39;dropout&#39;: 0.1894602780354472, &#39;learning_rate&#39;: 0.00024063232984383831}. Best is trial 3 with value: 418.26885986328125.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "68dcfff093cd4a70b2c0eb7a48e46ffd", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2207c4d6a5054a009e7e2c0ba0622a90", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d2af6fc52bec445cb02dc63d68dc9c4f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "edfa13a642af4d779d2c455808bef52b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "976cc907a9f849b988b4cd970893af4f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6ca1cae2b3444a95aa7160ec259d3a47", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a2a3f823f39a4ecc8373dbe4a5a4cf99", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fc995360db274fd09a2cc875f72526da", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-05-12 18:06:41,037] Trial 4 finished with value: 490.82293701171875 and parameters: {&#39;hidden_size&#39;: 47, &#39;attention_head_size&#39;: 2, &#39;dropout&#39;: 0.4331770229525512, &#39;learning_rate&#39;: 0.008182292556583298}. Best is trial 3 with value: 418.26885986328125.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ef1c78ab1a3344d5bd8b93c2c7a5e415", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2f8b5b01a3b14abb877db4d124ebb57f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7c09bb90063f4e16bb58a7b6ff091194", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "35854393638440d386932222068eccf8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "5654e2c42ce34d048cbbb5efc65db2ad", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8efed6673dd44a97b9de8d3b125802aa", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fdc6d998f35240cbaeffd66521ca1279", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fb788a24a28d4d818bc36792dd00880d", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-05-12 18:13:01,693] Trial 5 finished with value: 911.220947265625 and parameters: {&#39;hidden_size&#39;: 10, &#39;attention_head_size&#39;: 3, &#39;dropout&#39;: 0.35046752074386756, &#39;learning_rate&#39;: 0.003903925942933713}. Best is trial 3 with value: 418.26885986328125.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "fdb5f5c597164e0780430d7c733473ab", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "34ee698c3a324d4fbcfceb52e466deb4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c06ecfb460654e3595304884216a3316", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e0eb856c7475429aaa4533726c26d2b7", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8288c92f3a204dc0944efebfce8cb113", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "601fc6b13c904284be2ee3e6fd14ef2e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "bec33129c93e4e3a94d1bea37d9539c2", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "05484a4893ad4e8a94aeec823b6dad1b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e2308fb2c3d24462ab4564d3bc0b139c", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-05-12 18:20:21,180] Trial 6 finished with value: 613.4795532226562 and parameters: {&#39;hidden_size&#39;: 51, &#39;attention_head_size&#39;: 1, &#39;dropout&#39;: 0.19804023350134858, &#39;learning_rate&#39;: 0.00019907984487133688}. Best is trial 3 with value: 418.26885986328125.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "533c132dca304029b14e865a98fdae25", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "208a1be32acc449fa2d76b8cc44c618e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1f273934fa064c8f80d80a221912a39d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "11463764b7c341fbb2ace8fd40e036e4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "677092fd7e1b4774bb229ab281834620", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "26fefefad9fa47cd9b09157b6c4343f8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3dc11e54c7f3488aa6a08074620965b7", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "731eb8f2a0494490b796a48d44015605", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-05-12 18:26:39,943] Trial 7 finished with value: 709.7900390625 and parameters: {&#39;hidden_size&#39;: 47, &#39;attention_head_size&#39;: 3, &#39;dropout&#39;: 0.44721561239558505, &#39;learning_rate&#39;: 0.0004974056510736142}. Best is trial 3 with value: 418.26885986328125.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6974ea095a764ed394aa7d5579d7b841", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "816f38df6cec4ac4b7a8cea1c645b751", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "cdcf32b4d80d4f5186e5d746a156051b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a0bd40f4c1704147ae895a6580e6ca48", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "de7c7c673a9e46a6988c5641fc87e4da", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7a9faf658e204c7ead87281ccf46d924", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "65caa32bd94441068f69b6a10c22c80c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "5cf350861a8140a89318ddbf976fdac9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "96004719a048472f9d9b1a4eacc42f9b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "471cb8528c744631aa8917f6bfd10282", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-05-12 18:35:01,174] Trial 8 finished with value: 611.2453002929688 and parameters: {&#39;hidden_size&#39;: 60, &#39;attention_head_size&#39;: 4, &#39;dropout&#39;: 0.38419940297035426, &#39;learning_rate&#39;: 0.0004962239501416242}. Best is trial 3 with value: 418.26885986328125.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d2a0cd34fe1c404588a5ce68ee25be96", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f59f3420da9947da8e5b899aeacc0452", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "05cdabfa889d4027b15cc54364719bbb", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "cd92374cd8cc4fed9c4165dd56b3128e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a9cfbd88e4bf4ff493590cc98a2eaa8a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4b0eecb300d24ffe844f9b8b5c7e5507", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "168f50986b49443fa09b6c415b3751e9", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-05-12 18:40:09,386] Trial 9 finished with value: 963.106201171875 and parameters: {&#39;hidden_size&#39;: 17, &#39;attention_head_size&#39;: 1, &#39;dropout&#39;: 0.42550689421835874, &#39;learning_rate&#39;: 0.0018124113280209148}. Best is trial 3 with value: 418.26885986328125.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial:
{&#39;hidden_size&#39;: 34, &#39;attention_head_size&#39;: 2, &#39;dropout&#39;: 0.1894602780354472, &#39;learning_rate&#39;: 0.00024063232984383831}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">optuna.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_parallel_coordinate</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plot_parallel_coordinate</span><span class="p">(</span><span class="n">study</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="re-train-with-best-parameters">
<h3>Re-train with best parameters<a class="headerlink" href="#re-train-with-best-parameters" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_params</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">best_trial</span><span class="o">.</span><span class="n">params</span>

<span class="c1"># Create a logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">TensorBoardLogger</span><span class="p">(</span><span class="s2">&quot;tb_logs&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;tft_model&quot;</span><span class="p">)</span>

<span class="n">tft_best</span> <span class="o">=</span> <span class="n">TemporalFusionTransformer</span><span class="o">.</span><span class="n">from_dataset</span><span class="p">(</span>
    <span class="n">training</span><span class="p">,</span>
    <span class="o">**</span><span class="n">best_params</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">metrics</span><span class="o">.</span><span class="n">RMSE</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">early_stop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">accelerator</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">limit_train_batches</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stop</span><span class="p">],</span>
    <span class="n">enable_model_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">tft_best</span><span class="p">,</span> <span class="n">train_dataloaders</span><span class="o">=</span><span class="n">train_dataloader</span><span class="p">,</span> <span class="n">val_dataloaders</span><span class="o">=</span><span class="n">val_dataloader</span>
<span class="p">)</span>

<span class="c1"># Display tensorboard</span>
<span class="o">!</span>tensorboard<span class="w"> </span>--logdir<span class="w"> </span>tb_logs
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cae6c6097eb048f9956c43db7fcd9d0d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3aa214438cae4a9b946d1ec523044b63", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8e41c7bf557b47bbbe52ba121e5cc51e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e129541559684b4d8cd71f20704ab851", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e5cd3307f3144c3a8945f899f0696391", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c2942c2355bd4552ab6c87d99d66ff7e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "11032d9f2f804d7781755c913c7e7c7f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f2c75af8dc644874a37cb33bf4f1221f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a7251926e46c44b2af460c294bbda576", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "44fdd414684c405ea0d1e32f4390ba69", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4578424cd27b4b9d9e563f6291db1f86", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d4cab6f94a0b400b9f2c4d4c622daf3b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "086da8d69ead4bf79276c5388420a4e0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f907518595c84961b7c332a91b484782", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2576a967904442e1a8eb41e7e79884cd", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load best model</span>
<span class="c1"># best_model_path = trainer.checkpoint_callback.best_model_path</span>
<span class="c1"># best_tft = TemporalFusionTransformer.load_from_checkpoint(best_model_path)</span>

<span class="c1"># Predictions on validation set</span>
<span class="n">y_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">val_dataloader</span><span class="p">)])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">)</span>  <span class="c1"># Move to GPU</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">tft_best</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_dataloader</span><span class="p">)</span> <span class="c1">#.to(&quot;cuda:0&quot;)  # Ensure predictions are on GPU</span>

<span class="c1"># Calculate MSE</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>

<span class="n">mse</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MSE: </span><span class="si">{</span><span class="n">mse</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO: You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO:lightning.pytorch.utilities.rank_zero:You are using the plain ModelCheckpoint callback. Consider using LitModelCheckpoint which with seamless uploading to Model registry.
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
/usr/local/lib/python3.10/dist-packages/lightning/pytorch/trainer/connectors/data_connector.py:425: The &#39;predict_dataloader&#39; does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=31` in the `DataLoader` to improve performance.
/usr/local/lib/python3.10/dist-packages/lightning/pytorch/trainer/connectors/data_connector.py:425: The &#39;predict_dataloader&#39; does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=31` in the `DataLoader` to improve performance.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MSE: 187115.8750
</pre></div>
</div>
</div>
</div>
</section>
<section id="comparacion-de-modelos">
<h3>Comparación de modelos<a class="headerlink" href="#comparacion-de-modelos" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># About 80% code Generated with ChatGPT</span>
<span class="c1"># Prompt: &quot;Add a Wilcoxon test to compare the performance of the sklearn linear regression and pytorch-lightning models.&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlxtend.evaluate</span><span class="w"> </span><span class="kn">import</span> <span class="n">GroupTimeSeriesSplit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">wilcoxon</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pytorch_forecasting</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeriesDataSet</span><span class="p">,</span> <span class="n">TemporalFusionTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trainer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="c1"># Sample assumptions</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">train_val_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># encode date as consecutive integers</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span><span class="n">dates</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;distance_diff&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">group_column</span> <span class="o">=</span> <span class="s2">&quot;group&quot;</span>
<span class="n">time_column</span> <span class="o">=</span> <span class="s2">&quot;duration&quot;</span>
<span class="n">target_column</span> <span class="o">=</span> <span class="s2">&quot;distance&quot;</span>

<span class="c1"># Sort by group + time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">group_column</span><span class="p">,</span> <span class="n">time_column</span><span class="p">])</span>

<span class="c1"># Set up splitter</span>
<span class="n">cv_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;test_size&quot;</span><span class="p">:</span> <span class="n">test_size</span><span class="p">,</span> <span class="s2">&quot;n_splits&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
<span class="n">gtscv</span> <span class="o">=</span> <span class="n">GroupTimeSeriesSplit</span><span class="p">(</span><span class="o">**</span><span class="n">cv_args</span><span class="p">)</span>

<span class="n">tft_errors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">lr_errors</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Prepare data</span>
<span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target_column</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">gtscv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
    <span class="n">df_train</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>

    <span class="c1"># 1. --- sklearn regression model ---</span>
    <span class="n">lr_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
        <span class="c1"># (&#39;poly&#39;, PolynomialFeatures(degree=2, include_bias=False)),</span>
        <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
        <span class="p">(</span><span class="s2">&quot;feature_selection&quot;</span><span class="p">,</span> <span class="n">SelectKBest</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">mutual_info_regression</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">best_k</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;ridge&#39;</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;ridge__alpha&quot;</span><span class="p">]))</span>
    <span class="p">])</span>
    <span class="n">lr_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target_column</span><span class="p">,</span> <span class="n">group_column</span><span class="p">]),</span> <span class="n">df_train</span><span class="p">[</span><span class="n">target_column</span><span class="p">])</span>
    <span class="n">preds_rf</span> <span class="o">=</span> <span class="n">lr_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target_column</span><span class="p">,</span> <span class="n">group_column</span><span class="p">]))</span>
    <span class="n">error_rf</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="n">target_column</span><span class="p">],</span> <span class="n">preds_rf</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#RMSE</span>
    <span class="n">lr_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_rf</span><span class="p">)</span>

    <span class="c1"># 2. --- TFT model ---</span>
    <span class="c1"># Prepare TimeSeriesDataSet</span>
    <span class="c1"># Remove lag features</span>
    <span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;heartRate&quot;</span><span class="p">,</span> <span class="s2">&quot;elevation_diff&quot;</span><span class="p">,</span> <span class="s2">&quot;cadence&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;heartRate&quot;</span><span class="p">,</span> <span class="s2">&quot;elevation_diff&quot;</span><span class="p">,</span> <span class="s2">&quot;cadence&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">group_column</span><span class="p">,</span> <span class="n">time_column</span><span class="p">])</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">group_column</span><span class="p">,</span> <span class="n">time_column</span><span class="p">])</span>
    <span class="n">training</span> <span class="o">=</span> <span class="n">TimeSeriesDataSet</span><span class="p">(</span>
        <span class="n">df_train</span><span class="p">,</span>
        <span class="n">time_idx</span><span class="o">=</span><span class="n">time_column</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">target_column</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="o">=</span><span class="p">[</span><span class="n">group_column</span><span class="p">],</span>
        <span class="n">max_encoder_length</span><span class="o">=</span><span class="n">max_encoder_length</span><span class="p">,</span>
        <span class="n">min_encoder_length</span><span class="o">=</span><span class="n">min_encoder_length</span><span class="p">,</span>
        <span class="n">min_prediction_length</span><span class="o">=</span><span class="n">min_prediction_length</span><span class="p">,</span>
        <span class="n">max_prediction_length</span><span class="o">=</span><span class="n">max_prediction_length</span><span class="p">,</span>
        <span class="c1"># static_categoricals=[],</span>
        <span class="c1"># time_varying_known_categoricals=[],</span>
        <span class="n">time_varying_known_reals</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;heartRate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;altitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elevation_diff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elevation_gain&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elevation_loss&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cadence&quot;</span><span class="p">,</span>
            <span class="s2">&quot;speed&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">time_varying_unknown_reals</span><span class="o">=</span><span class="p">[</span><span class="n">target_column</span><span class="p">],</span>
        <span class="n">target_normalizer</span><span class="o">=</span><span class="n">GroupNormalizer</span><span class="p">(</span>
            <span class="n">groups</span><span class="o">=</span><span class="p">[</span><span class="n">group_column</span><span class="p">],</span> <span class="n">transformation</span><span class="o">=</span><span class="s2">&quot;softplus&quot;</span>
        <span class="p">),</span>
        <span class="n">add_relative_time_idx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">add_target_scales</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">add_encoder_length</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_missing_timesteps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># validation = TimeSeriesDataSet.from_dataset(training, df_test)</span>
    <span class="n">validation</span> <span class="o">=</span> <span class="n">TimeSeriesDataSet</span><span class="p">(</span>
        <span class="n">df_test</span><span class="p">,</span>
        <span class="n">time_idx</span><span class="o">=</span><span class="n">time_column</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">target_column</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="o">=</span><span class="p">[</span><span class="n">group_column</span><span class="p">],</span>
        <span class="n">max_encoder_length</span><span class="o">=</span><span class="n">max_encoder_length</span><span class="p">,</span>
        <span class="n">min_encoder_length</span><span class="o">=</span><span class="n">min_encoder_length</span><span class="p">,</span>
        <span class="n">min_prediction_length</span><span class="o">=</span><span class="n">min_prediction_length</span><span class="p">,</span>
        <span class="n">max_prediction_length</span><span class="o">=</span><span class="n">max_prediction_length</span><span class="p">,</span>
        <span class="c1"># static_categoricals=[],</span>
        <span class="c1"># time_varying_known_categoricals=[],</span>
        <span class="n">time_varying_known_reals</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;heartRate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;altitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elevation_diff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elevation_gain&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elevation_loss&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cadence&quot;</span><span class="p">,</span>
            <span class="s2">&quot;speed&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">time_varying_unknown_reals</span><span class="o">=</span><span class="p">[</span><span class="n">target_column</span><span class="p">],</span>
        <span class="n">target_normalizer</span><span class="o">=</span><span class="n">training</span><span class="o">.</span><span class="n">target_normalizer</span><span class="p">,</span> <span class="c1"># Use normalizer from training</span>
        <span class="n">add_relative_time_idx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">add_target_scales</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">add_encoder_length</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_missing_timesteps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1"># Pass the categorical encoders from the training dataset</span>
        <span class="n">categorical_encoders</span><span class="o">=</span><span class="n">training</span><span class="o">.</span><span class="n">categorical_encoders</span><span class="p">,</span>
        <span class="n">scalers</span><span class="o">=</span><span class="n">training</span><span class="o">.</span><span class="n">scalers</span> <span class="c1"># Pass the scalers from the training dataset</span>
    <span class="p">)</span>

    <span class="n">train_dl</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">to_dataloader</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">val_dl</span> <span class="o">=</span> <span class="n">validation</span><span class="o">.</span><span class="n">to_dataloader</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>

    <span class="n">early_stop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
        <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">accelerator</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
        <span class="n">limit_train_batches</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stop</span><span class="p">],</span>
        <span class="n">enable_model_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Ensure the model is reset before training</span>
    <span class="n">tft_best</span> <span class="o">=</span> <span class="n">TemporalFusionTransformer</span><span class="o">.</span><span class="n">from_dataset</span><span class="p">(</span>
        <span class="n">training</span><span class="p">,</span>
        <span class="o">**</span><span class="n">best_params</span><span class="p">,</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">metrics</span><span class="o">.</span><span class="n">RMSE</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tft_best</span><span class="p">,</span> <span class="n">train_dl</span><span class="p">,</span> <span class="n">val_dl</span><span class="p">)</span>

    <span class="n">preds_tft</span> <span class="o">=</span> <span class="n">tft_best</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_dl</span><span class="p">)</span>
    <span class="n">actuals</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">val_dl</span><span class="p">)])</span>

    <span class="c1"># error_tft = mean_squared_error(actuals.cpu().numpy(), preds_tft.cpu().numpy())</span>
    <span class="n">error_tft</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">callback_metrics</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">]</span>
    <span class="n">tft_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_tft</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 3. --- Wilcoxon Test ---</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tft_errors</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lr_errors</span><span class="p">)</span>

<span class="c1"># Plot tft_errors and lr_errors</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tft_errors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;TFT Errors&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lr_errors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LR Errors&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fold&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;RMSE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Model Errors Comparison&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Perform Wilcoxon signed-rank test</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr_errors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tft_errors</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr_errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">wilcoxon</span><span class="p">(</span><span class="n">lr_errors</span><span class="p">,</span> <span class="n">tft_errors</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wilcoxon test statistic: </span><span class="si">{</span><span class="n">stat</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wilcoxon test p-value: </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Interpret the result</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reject the null hypothesis: There is a significant difference in performance between the two models.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fail to reject the null hypothesis: There is no significant difference in performance between the two models.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough paired samples to perform Wilcoxon test.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="conclusiones">
<h2>Conclusiones<a class="headerlink" href="#conclusiones" title="Link to this heading">#</a></h2>
<p>Los problemas de series de tiempo representa un reto por el tratamiento que deben tener los datos y por el cuidado que se debe tener al momento de realizar las validaciones correspondientes para evitar data leakage. Por un lado se tiene las series de tiempo en el que es importante validar con datos futuros. Por otro lado se tiene distintos registros correspondientes a distintos entrenamientos, cada uno de estos grupos debe estar en un conjunto distinto, entrenamiento o validacion para evitar una contaminacion de datos. Esto puede volverse aun mas complejo se agrega data correspondiente a individuos adicionales.</p>
<p>A pesar de que un problema de series de tiempo puede parecer computacionalmente simple al tener pocas caracteristicas sobre las cuales trabajar y un numero limitado de sesiones de la actividad deportiva realizada, al agregar todas estas sesiones, el dataset crece significativamente, llegando a los cientos de miles de registros en total. Adicionalmente, si se agregan características adicionales de lag y polinomiales puede derivar en un dataset significativamente grande que puede aumentar el tiempo de ejecución de manera significativa.</p>
<p>La implementación modular de los distintos componentes tanto para la preparación del dataset, como para la definición del modelo y optimización de hiperparámetros es clave para poder orquestar el código y adaptarlo a los distintos problemas que se puedan sucitar. Esta modularidad incluso permite la combinación de distintas librerías para tareas como la evaluación de modelos. El seguir las mejores prácticas a la hora de implementar las distintas soluciones ayuda a que el código tenga una mejor organización.</p>
<p>En éste proyecto se tuvo la oportunidad de evaluar 2 modelos distintos (regresión líneal regularizada y redes neuronales) usando 2 distintas librerias (scikit-learn y pytorch). Es interesante contrastar las diferencias entre los modelos y las librerias. Por un lado la regresión lineal es más simple a nivel de modelo pero puede tener más complejidades a la hora de procesar el dataset (requiriendo features adicionales) o requerir mas procesos dentro del pipeline. Por otro lado, las redes neuronales requieren un mejor entendimiento de la arquitectura subyacente sobre todo a la hora de escoger los hiperparámetros a optimizar. A nivel de librerias, scikit-learn ofrece un conjunto de librerias muy completo y con una API que facilita su uso, sin embargo puede no proveer ciertas opciones para problemas más complejos como grupos para <code class="docutils literal notranslate"><span class="pre">TimeSeriesSplit</span></code>. Pytorch y todo su ecosistema en cambio ofrece una mayor versatilidad y flexibilidad a cambio de adherirse a ciertos estandares como el uso de interfaces a través de las clases base de Lightning y la aplicación de un paradigma orientado a objetos para la modularidad y extensibilidad de los componentes.</p>
<p>Para el presente proyecto se tomó una sola variable de predicción como es la distancia que es fácil de explicar si se tiene el tiempo en intervalos de tamaño fijo, un poco pensado en la intuición de que se quisiera saber la distancia que se podría recorrer dadas ciertas condiciones. Sin embargo, ésto pudiese extenderse a muchas otras variables de interés. En realidad, la distancia es un parámetro estático y conocido, asi también la altura y sus métricas asociadas como desnivel tanto positivo como negativo (esto usualmente viene dado por un archivo GPX que se comparte antes de un entrenamiento o competencia). Por esta razón, la variable de interés real es el tiempo y habría que considerar para una futura investigación la posibilidad de hacer un remuestreo que permita tener la distancia en intervalos fijos para poder considerar como un problema de serie pero basado en la distancia. Asi mismo, se pueden introducir otras variables que pueden cambiar la dinámica del modelo como el nivel de terreno, condiciones climáticas, en que punto comer, en que punto hidratarse y nivel de esfuerzo percibido.</p>
</section>
<section id="referencias">
<h2>Referencias<a class="headerlink" href="#referencias" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>[1] Nguyen et al., <a class="reference external" href="https://export.arxiv.org/pdf/1708.07942v1.pdf">m-TSNE: A Framework for Visualizing High-Dimensional Multivariate Time Series</a></p></li>
<li><p>[2] Sebastian Raschka, <a class="reference external" href="https://rasbt.github.io/mlxtend/user_guide/evaluate/GroupTimeSeriesSplit/">GroupTimeSeriesSplit: A scikit-learn compatible version of the time series validation with groups</a></p></li>
<li><p>[3] Lim et al., <a class="reference external" href="https://arxiv.org/pdf/1912.09363v3">Temporal Fusion Transformers for Interpretable Multi-horizon Time Series Forecasting</a></p></li>
<li><p>[4] Dmitry Labazkin, <a class="reference external" href="https://medium.com/&#64;labdmitriy/advanced-group-time-series-validation-bb00d4a74bcc">Advanced Group Time Series Validation</a></p></li>
<li><p>[5] Mario Dagrada, <a class="reference external" href="https://medium.com/data-science/ml-time-series-forecasting-the-right-way-cbf3678845ff">ML time series forecasting the right way</a></p></li>
<li><p>[6] <a class="reference external" href="https://pytorch-forecasting.readthedocs.io/en/stable/tutorials/stallion.html">Demand forecasting with the Temporal Fusion Transformer</a></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduccion">Introducción</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation-y-justificacion">Motivation y Justificación</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#que-es-el-running">¿Qué es el running?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#que-es-el-trail-running">¿Qué es el trail running?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#que-es-el-ultra-trail-running">¿Qué es el <em>ultra</em> trail running?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#por-que-es-importante">¿Por qué es importante?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#eda-exploratory-data-analysis">EDA (Exploratory Data Analysis)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preprocessing">Data preprocessing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analisis-de-los-datos">Análisis de los datos</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#graficas-de-variables-con-respecto-al-tiempo">Gráficas de variables con respecto al tiempo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#observaciones">Observaciones:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Observaciones</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Observaciones</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Observaciones</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizacion-con-tsne">Visualización con TSNE</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Observaciones:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Observaciones:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-selection-filter">Feature Selection (Filter)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lag-features">Lag Features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conjuntos-de-entrenamiento-validacion-y-prueba">Conjuntos de entrenamiento, validación y prueba</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Observaciones:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparacion-de-estadistica-de-2-tecnicas-de-ml">Comparación de estadística de 2 técnicas de ML</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regresion-lineal-regularizada">Regresión Lineal Regularizada</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#librerias-requeridas">Librerias requeridas</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#preparacion-de-datos">Preparación de datos</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pipeline">Pipeline</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizacion-de-hyperparametros">Optimización de hyperparámetros</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizacion-de-resultados">Visualización de resultados</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#entrenamiento-y-evaluacion">Entrenamiento y Evaluación</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#neural-network-con-tft-temporal-fusion-transformers">Neural Network con TFT (Temporal Fusion Transformers)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Librerias requeridas</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset">Dataset</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-and-hyperparameter-optimization">Model and Hyperparameter Optimization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#re-train-with-best-parameters">Re-train with best parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparacion-de-modelos">Comparación de modelos</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusiones">Conclusiones</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#referencias">Referencias</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Eric Aguayo
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>